{% extends "base.html" %}
{% block title %}Decisions - BidLens{% endblock %}
{% block content %}
<h1>Decisions</h1>

<div class="tabs">
  <a href="/saved?state=saved{% if type_filter %}&type={{ type_filter }}{% endif %}"
     class="tab {{ 'active' if state_filter == 'saved' else '' }}">Shortlist</a>

  <a href="/saved?state=bid{% if type_filter %}&type={{ type_filter }}{% endif %}"
     class="tab {{ 'active' if state_filter == 'bid' else '' }}">Bid</a>

  <a href="/saved?state=no_bid{% if type_filter %}&type={{ type_filter }}{% endif %}"
     class="tab {{ 'active' if state_filter == 'no_bid' else '' }}">No Bid</a>
</div>

<form method="GET" class="filters">
  <input type="hidden" name="state" value="{{ state_filter or 'saved' }}">
  <select name="type" onchange="this.form.submit()">
      <option value="">All Types</option>
      <option value="solicitation" {{ 'selected' if type_filter == 'solicitation' else '' }}>Solicitations</option>
      <option value="rfi" {{ 'selected' if type_filter == 'rfi' else '' }}>RFIs & Sources Sought</option>
  </select>
</form>

<div class="saved-count">
  {% if saved_items %}
    {{ saved_items|length }} opportunities
  {% endif %}
</div>
{% if saved_items %}
    {% for item in saved_items %}
        <div class="card">
            <div class="card-header">
                <a href="/opportunity/{{ item.opportunity.id }}" class="card-title">{{ item.opportunity.title }}</a>
                {% if state_filter == 'saved' %}
                  <span class="badge badge-saved">Shortlisted</span>
                {% elif state_filter == 'bid' %}
                  <span class="badge badge-inprogress">Go Bid</span>
                {% elif state_filter == 'no_bid' %}
                  <span class="badge badge-dropped">No Bid</span>
                {% else %}
                  <span class="badge badge-saved">Shortlisted</span>
                {% endif %}
            </div>
            <div class="card-meta">
                <span class="card-agency">{{ item.opportunity.agency }}</span>
                <span class="badge {{ 'badge-rfi' if item.opportunity.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">{{ item.opportunity.opportunity_type }}</span>
            </div>
            <div class="card-meta">
                <span class="due-date">
                    {% if item.internal_deadline %}
                        Your deadline: {{ item.internal_deadline.strftime('%b %d, %Y') }}
                    {% else %}
                        Due: {{ item.opportunity.response_deadline.strftime('%b %d, %Y') }}
                    {% endif %}
                </span>
            </div>
            {% if item.notes %}
            <div class="card-meta">
                <span style="font-style: italic; color: var(--gray-500);">{{ item.notes[:100] }}{% if item.notes|length > 100 %}...{% endif %}</span>
            </div>
            {% endif %}
          <div class="card-meta" style="display:flex; gap:12px;">
            <span>Shortlist {{ item.up_count }}</span>
            <span>Pass {{ item.down_count }}</span>
          </div>

            <div class="card-actions">
              {% if state_filter == 'saved' %}
                <button
                  type="button"
                  class="btn btn-success btn-sm"
                  onclick="transitionOpp('{{ item.opportunity.id }}','BID')"
                >
                  Go Bid
                </button>

                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  onclick="transitionOpp('{{ item.opportunity.id }}','NO_BID')"
                >
                  No Bid
                </button>
              {% endif %}

              <a href="/opportunity/{{ item.opportunity.id }}" class="btn btn-secondary btn-sm">View Details</a>
            </div>
            <div class="card-footer">
              {% if item.created_at %}
                <span class="saved-date">Saved on {{ item.created_at.strftime('%b %d, %Y') }}</span>
              {% endif %}
            </div>
        </div>
    {% endfor %}
{% else %}
  <div class="empty-state">
    {% if state_filter == 'saved' %}
      <h2>No shortlisted opportunities</h2>
      <p>Start by browsing the <a href="/">feed</a> and shortlisting opportunities you're interested in.</p>
    {% elif state_filter == 'bid' %}
      <h2>No Go Bid decisions yet</h2>
      <p>Move an opportunity from Shortlist to Go Bid when youâ€™ve decided to pursue it.</p>
    {% elif state_filter == 'no_bid' %}
      <h2>No No Bid decisions yet</h2>
      <p>Mark opportunities as No Bid from the Feed or Shortlist.</p>
    {% else %}
      <h2>No opportunities</h2>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
{% block scripts %}
<script>
async function transitionOpp(oppId, toState) {
  const res = await fetch('/api/transition', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      to_state: toState,
      ui_version: "v1"
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || 'Error');
    return;
  }
  window.location.reload();
}
</script>
{% endblock %}

