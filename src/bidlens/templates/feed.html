{% extends "base.html" %}
{% block title %}Feed - BidLens{% endblock %}
{% block content %}
<h1>New Opportunities</h1>

<div class="tabs">
    <a href="/?tab=solicitations{% if show_all %}&show_all=1{% endif %}" class="tab {{ 'active' if current_tab == 'solicitations' else '' }}">Solicitations</a>
    <a href="/?tab=rfi{% if show_all %}&show_all=1{% endif %}" class="tab {{ 'active' if current_tab == 'rfi' else '' }}">RFIs & Sources Sought</a>
</div>

{% if opportunities %}
    {% for opp in opportunities %}
        <div class="card">
            <div class="card-header">
                <a href="/opportunity/{{ opp.id }}" class="card-title">{{ opp.title }}</a>
                <span class="badge {{ 'badge-rfi' if opp.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">{{ opp.opportunity_type }}</span>
            </div>
            <div class="card-meta">
                <span class="card-agency">{{ opp.agency }}</span>
                {% if opp.set_aside %}
                    <span class="badge badge-setaside">{{ opp.set_aside }}</span>
                {% endif %}
                {% if opp.naics %}
                    <span>NAICS: {{ opp.naics }}</span>
                {% endif %}
            </div>
            <div class="card-meta">
                <span class="due-date {{ 'due-urgent' if opp.days_until_due <= 7 else 'due-soon' if opp.days_until_due <= 14 else '' }}">
                    Due: {{ opp.response_deadline.strftime('%b %d, %Y') }}
                    {% if opp.days_until_due >= 0 %}
                        ({{ opp.days_until_due }} days)
                    {% else %}
                        (past due)
                    {% endif %}
                </span>
            </div>
            <div class="card-actions">
             <!--{# 
              ORG-LEVEL DECISION ACTIONS (BID / NO BID)
              Intentionally deferred. Will re-enable once workflow layer is finalized.
              #} {% if opp.user_status %}
                {% set status = opp.user_status %}
                {% include "_status_badge.html" %}
              {% endif %}
              {# Show Save unless already saved/in progress #}
              {% if opp.user_status not in ['saved', 'in_progress'] %}
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  onclick="transitionOpp('{{ opp.id }}','SAVED')"
                >Shortlist</button>
              {% endif %}

              {# Show Skip unless already skipped #}
              {% if opp.user_status != 'dropped' %}
                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  onclick="transitionOpp('{{ opp.id }}','NO_BID')"
                >No Bid</button>
              {% endif %}-->
              <div class="card-actions">

                <div class="signal-counts">
                  <span>Interested: {{ opp.pursue_count }}</span>
                  <span>Not Interested: {{ opp.pass_count }}</span>
                  <span class="badge badge-score">
                    Fit: {{ opp.fit_score if opp.fit_score is defined else 'â€”' }}
                  </span>
                </div>

                <!-- Pursue / Pass buttons -->
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  onclick="castVote('{{ opp.id }}', 'UP')"
                >
                  Interested
                </button>

                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="castVote('{{ opp.id }}', 'PASS')"
                >
                  Not Interested
                </button>

                <!-- Save for Later (watch) -->
                <form
                  method="POST"
                  action="/opportunity/{{ opp.id }}/watch"
                  style="display:inline;"
                >
                  <button class="btn btn-outline-secondary btn-sm" type="submit">
                    {% if opp.watched %}Saved{% else %}Save for Later{% endif %}
                  </button>
                </form>

                <a href="/opportunity/{{ opp.id }}" class="btn btn-secondary btn-sm">
                  View Details
                </a>
              </div>
            </div>
        </div>
    {% endfor %}
    {% if not show_all %}
      <div class="show-more">
        <a href="/?tab={{ current_tab }}&show_all=1">Show passed</a>
      </div>
    {% else %}
      <div class="show-more">
        <a href="/?tab={{ current_tab }}">&larr; Hide passed</a>
      </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <h2>No opportunities found</h2>
        <p>Check back later for new {{ 'solicitations' if current_tab == 'solicitations' else 'RFIs and Sources Sought' }}.</p>
    </div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
async function transitionOpp(oppId, toState) {
  const res = await fetch('/api/transition', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      to_state: toState,
      ui_version: "v1"
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || 'Error');
    return;
  }
  window.location.reload();
}

async function castVote(oppId, voteValue) {
  const res = await fetch('/api/vote', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      vote: voteValue,
      ui_version: "v1"
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || 'Error');
    return;
  }

  window.location.reload();
}
</script>
{% endblock %}

