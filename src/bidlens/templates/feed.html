{% extends "base.html" %}
{% block title %}Feed - BidLens{% endblock %}
{% block content %}
<h1>Feed</h1>
<!--Details about what is being pulled into feed-->
<div class="feed-context">
  <div class="context-row">
    <span class="context-label">Types:</span>
    <span class="context-value">
      {% if active_tab == "solicitations" %}
        Solicitation, Combined Synopsis/Solicitation
      {% elif active_tab == "RFIs" %}
        Sources Sought, RFI, Special Notice, Presolicitation
      {% endif %}
    </span>
  </div>

  <div class="context-row">
    <span class="context-label">NAICS:</span>
    <span class="context-value">541611, 541690</span>
  </div>

  <div class="context-row">
    <span class="context-label">Window:</span>
    <span class="context-value">Last 7 days</span>
  </div>
</div>

<div class="tabs">
  <a href="/?tab=solicitations" class="tab {{ 'active' if current_tab == 'solicitations' else '' }}">Solicitations</a>
  <a href="/?tab=rfi" class="tab {{ 'active' if current_tab == 'rfi' else '' }}">RFIs</a>
</div>

<!-- For secondary tabs inside Feed
<div class="tabs">
  <a href="/" class="tab {{ 'active' if active_page == 'feed' else '' }}">Feed</a>
  <div class="filters">
    <a href="/" class="filter active">All</a>
    <a href="/?filter=shortlisted" class="filter">Shortlisted</a>
    <a href="/?filter=watchlist" class="filter">My Watchlist</a>
  </div>

</div> -->


{% if opportunities %}
    {% for opp in opportunities %}
        <div class="card">
            <div class="card-header">
                <a href="/opportunity/{{ opp.id }}" class="card-title">{{ opp.title }}</a>
                <span class="badge {{ 'badge-rfi' if opp.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">{{ opp.opportunity_type }}</span>
            </div>
            <div class="card-meta">
                <span class="card-agency">{{ opp.agency }}</span>
                {% if opp.set_aside %}
                    <span class="badge badge-setaside">{{ opp.set_aside }}</span>
                {% endif %}
                {% if opp.naics %}
                    <span>NAICS: {{ opp.naics }}</span>
                {% endif %}
            </div>
            <div class="card-meta">
                <span class="due-date {{ 'due-urgent' if opp.days_until_due <= 7 else 'due-soon' if opp.days_until_due <= 14 else '' }}">
                    Due: {{ opp.response_deadline.strftime('%b %d, %Y') }}
                    {% if opp.days_until_due >= 0 %}
                        ({{ opp.days_until_due }} days)
                    {% else %}
                        (past due)
                    {% endif %}
                </span>
            </div>
          <div class="card-actions">
            <div class="actions-left">
              <button
                type="button"
                class="btn btn-primary btn-sm {% if opp.my_signal == 'UP' %}is-selected{% endif %}"
                onclick="castVote('{{ opp.id }}', 'UP', '{{ opp.my_signal or '' }}')"
              >
                Shortlist ({{ opp.pursue_count }})
              </button>

              <button
                type="button"
                class="btn btn-secondary btn-sm {% if opp.my_signal == 'DOWN' %}is-selected{% endif %}"
                onclick="castVote('{{ opp.id }}', 'DOWN', '{{ opp.my_signal or '' }}')"
              >
                Pass ({{ opp.pass_count }})
              </button>
            </div>

            <div class="actions-right">
              <form method="POST" action="/opportunity/{{ opp.id }}/watch" style="display:inline;">
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                  {% if opp.watched %}★{% else %}☆Bookmark{% endif %}
                </button>
              </form>

              <a href="/opportunity/{{ opp.id }}" class="details-link">Details →</a>
            </div>
          </div>

        </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <h2>No opportunities found</h2>
        <p>Check back later for new {{ 'solicitations' if current_tab == 'solicitations' else 'RFIs and Sources Sought' }}.</p>
    </div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
const SIGNAL_LABEL = { UP: "Shortlist", DOWN: "Pass" };
async function transitionOpp(oppId, toState) {
  const res = await fetch('/api/transition', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      to_state: toState,
      ui_version: "v1"
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || 'Error');
    return;
  }
  window.location.reload();
}

async function castVote(oppId, voteValue, currentSignal) {
  const payload = { opp_id: Number(oppId), ui_version: "v1" };
  payload.vote = (currentSignal === voteValue) ? null : voteValue;

  const res = await fetch('/api/vote', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    alert(data.detail || 'Error');
    return;
  }
  window.location.reload();
}



</script>
{% endblock %}

