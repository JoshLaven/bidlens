{% extends "base.html" %}
{% block title %}Feed - BidLens{% endblock %}
{% block content %}
<h1>New Opportunities</h1>

<div class="tabs">
  <a href="/" class="tab {{ 'active' if active_page == 'feed' else '' }}">Feed</a>
  <a href="/watchlist" class="tab {{ 'active' if active_page == 'watchlist' else '' }}">My Watchlist</a>
</div>


{% if opportunities %}
    {% for opp in opportunities %}
        <div class="card">
            <div class="card-header">
                <a href="/opportunity/{{ opp.id }}" class="card-title">{{ opp.title }}</a>
                <span class="badge {{ 'badge-rfi' if opp.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">{{ opp.opportunity_type }}</span>
            </div>
            <div class="card-meta">
                <span class="card-agency">{{ opp.agency }}</span>
                {% if opp.set_aside %}
                    <span class="badge badge-setaside">{{ opp.set_aside }}</span>
                {% endif %}
                {% if opp.naics %}
                    <span>NAICS: {{ opp.naics }}</span>
                {% endif %}
            </div>
            <div class="card-meta">
                <span class="due-date {{ 'due-urgent' if opp.days_until_due <= 7 else 'due-soon' if opp.days_until_due <= 14 else '' }}">
                    Due: {{ opp.response_deadline.strftime('%b %d, %Y') }}
                    {% if opp.days_until_due >= 0 %}
                        ({{ opp.days_until_due }} days)
                    {% else %}
                        (past due)
                    {% endif %}
                </span>
            </div>
          <div class="card-actions">
            <div class="actions-left">
              <button
                type="button"
                class="btn btn-primary btn-sm signal-btn {% if opp.my_signal == "UP" %}is-selected{% endif %}"
                onclick="castVote('{{ opp.id }}', 'UP', '{{ opp.my_signal or "" }}')"
              >
                Shortlist <span class="signal-dot">·</span> <span class="signal-count">{{ opp.pursue_count }}</span>
                {% if opp.my_signal == "UP" %}<span class="signal-check">✓</span>{% endif %}
              </button>

              <button
                type="button"
                class="btn btn-secondary btn-sm signal-btn {% if opp.my_signal == "DOWN" %}is-selected{% endif %}"
                onclick="castVote('{{ opp.id }}', 'DOWN', '{{ opp.my_signal or "" }}')"
              >
                Pass <span class="signal-dot">·</span> <span class="signal-count">{{ opp.pass_count }}</span>
                {% if opp.my_signal == "DOWN" %}<span class="signal-check">✓</span>{% endif %}
              </button>
            </div>

            <div class="actions-right">
              <form method="POST" action="/opportunity/{{ opp.id }}/watch" style="display:inline;">
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                  {% if opp.watched %}Saved{% else %}Save{% endif %}
                </button>
              </form>
              <a href="/opportunity/{{ opp.id }}" class="details-link">
                Details
              </a>
            </div>
          </div>
        </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <h2>No opportunities found</h2>
        <p>Check back later for new {{ 'solicitations' if current_tab == 'solicitations' else 'RFIs and Sources Sought' }}.</p>
    </div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
const SIGNAL_LABEL = { UP: "Shortlist", DOWN: "Pass" };
async function transitionOpp(oppId, toState) {
  const res = await fetch('/api/transition', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      to_state: toState,
      ui_version: "v1"
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.detail || 'Error');
    return;
  }
  window.location.reload();
}

async function castVote(oppId, voteValue, currentSignal) {
  const payload = {
    opp_id: Number(oppId),
    ui_version: "v1"
  };

  if (currentSignal === voteValue) {
    payload.vote = null;  // clear
  } else {
    payload.vote = voteValue;  // "UP" or "DOWN"
  }

  await fetch('/api/vote', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  window.location.reload();
}


</script>
{% endblock %}

