{% extends "base.html" %}
{% block title %}{{ opportunity.title }} - BidLens{% endblock %}

{% block content %}
<div class="detail-page">

  <a href="/" class="btn btn-secondary btn-sm" style="margin-bottom: 24px;">
    &larr; Back to Feed
  </a>

  <div class="detail-header">
    <div class="detail-title-row">
      <h1 class="detail-title">{{ opportunity.title }}</h1>
      <span class="badge {{ 'badge-rfi' if opportunity.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">
        {{ opportunity.opportunity_type }}
      </span>
    </div>

    <div class="card-actions" style="margin-bottom: 16px;">
      <div class="actions-left">
        <button type="button"
                class="btn btn-primary btn-sm {% if my_vote == 'UP' %}is-selected{% endif %}"
                onclick="voteOpp('{{ opportunity.id }}', 'UP', '{{ my_vote or '' }}')">
          Shortlist ({{ up_count }})
        </button>

        <button type="button"
                class="btn btn-secondary btn-sm {% if my_vote == 'DOWN' %}is-selected{% endif %}"
                onclick="voteOpp('{{ opportunity.id }}', 'DOWN', '{{ my_vote or '' }}')">
          Pass ({{ down_count }})
        </button>
      </div>

      <div class="actions-right">
        <form method="POST" action="/opportunity/{{ opportunity.id }}/watch" style="display:inline;">
          <button class="btn btn-outline-secondary btn-sm" type="submit" title="Bookmark">
            {% if user_opp and user_opp.watched %}★{% else %}☆{% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="detail-primary">

    <!-- Key Info -->
    <details open class="accordion">
      <summary class="accordion-summary">Key Info</summary>
      <div class="accordion-body">

        <div class="key-info-row">
          <span class="key-info-label">Agency</span>
          <span class="key-info-value">{{ opportunity.agency }}</span>
        </div>

        <div class="key-info-row">
          <span class="key-info-label">Response Deadline</span>
          <span class="key-info-value {{ 'due-urgent' if days_until_due <= 7 else 'due-soon' if days_until_due <= 14 else '' }}">
            {{ opportunity.response_deadline.strftime('%B %d, %Y') }}
            {% if days_until_due >= 0 %}
              ({{ days_until_due }} days left)
            {% else %}
              (past due)
            {% endif %}
          </span>
        </div>

        <div class="key-info-row">
          <span class="key-info-label">Posted Date</span>
          <span class="key-info-value">{{ opportunity.posted_date.strftime('%B %d, %Y') }}</span>
        </div>

        {% if opportunity.naics %}
          <div class="key-info-row">
            <span class="key-info-label">NAICS</span>
            <span class="key-info-value">{{ opportunity.naics }}</span>
          </div>
        {% endif %}

        {% if opportunity.set_aside %}
          <div class="key-info-row">
            <span class="key-info-label">Set-Aside</span>
            <span class="key-info-value">{{ opportunity.set_aside }}</span>
          </div>
        {% endif %}

        <div class="key-info-row">
          <span class="key-info-label">SAM.gov ID</span>
          <span class="key-info-value">{{ opportunity.sam_notice_id }}</span>
        </div>

        {% if user_opp and user_opp.internal_deadline %}
          <div class="key-info-row">
            <span class="key-info-label">Internal Deadline</span>
            <span class="key-info-value">{{ user_opp.internal_deadline.strftime('%B %d, %Y') }}</span>
          </div>
        {% endif %}

        {% if opportunity.sam_url %}
          <a href="{{ opportunity.sam_url }}" target="_blank"
             class="btn btn-secondary btn-sm"
             style="margin-top: 12px; justify-content: center;">
            View on SAM.gov &rarr;
          </a>
        {% endif %}

      </div>
    </details>

    <!-- Opportunity Brief -->
    <details open class="accordion">
      <summary class="accordion-summary">Opportunity Brief</summary>
      <div class="accordion-body">

        <div class="brief-actions" style="display:flex; justify-content:flex-end; margin-bottom: 12px;">
          <button class="btn btn-secondary btn-sm"
                  type="button"
                  onclick="generateBrief('{{ opportunity.id }}')">
            Generate AI Brief
          </button>
        </div>

        <div class="brief-content">
          {% if brief %}
            {% if brief.summary_bullets %}
              <ul>
                {% for b in brief.summary_bullets %}
                  <li>{{ b }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if brief.key_requirements %}
              <h4>Key requirements</h4>
              <ul>
                {% for x in brief.key_requirements %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if brief.deliverables %}
              <h4>Deliverables</h4>
              <ul>
                {% for x in brief.deliverables %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if brief.eligibility %}
              <h4>Eligibility</h4>
              <ul>
                {% for x in brief.eligibility %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if brief.red_flags %}
              <h4>Red flags</h4>
              <ul>
                {% for x in brief.red_flags %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if brief.recommended_next_steps %}
              <h4>Recommended next steps</h4>
              <ul>
                {% for x in brief.recommended_next_steps %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            {% endif %}

          {% else %}
            {% if brief_status == "pending" %}
              <script>
                setTimeout(() => window.location.reload(), 5000);
              </script>
              <p><em>Generating summary…</em></p>
            {% elif brief_status == "failed" %}
              <p><strong>Brief failed:</strong> {{ brief_error or "unknown error" }}</p>
            {% else %}
              <p><em>No brief yet. Click “Generate AI Brief” to create one.</em></p>
            {% endif %}
          {% endif %}
        </div>

      </div>
    </details>

    <!-- Original description -->
    {% if opportunity.description %}
      <details class="accordion">
        <summary class="accordion-summary">Original SAM.gov Description</summary>
        <div class="accordion-body prewrap">
          {{ opportunity.description }}
        </div>
      </details>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function voteOpp(oppId, voteValue, currentVote) {
  const payload = {
    opp_id: Number(oppId),
    ui_version: "v1",
    vote: (currentVote === voteValue) ? null : voteValue
  };

  const res = await fetch('/api/vote', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    alert(data.detail || "Error saving vote");
    return;
  }

  window.location.reload();
}

async function generateBrief(oppId) {
  await fetch(`/api/opps/${oppId}/generate_brief`, { method: "POST" });
  window.location.reload();
}
</script>
{% endblock %}
