{% extends "base.html" %}
{% block title %}{{ opportunity.title }} - BidLens{% endblock %}
{% block content %}
<div class="detail-page">
    <a href="/" class="btn btn-secondary btn-sm" style="margin-bottom: 24px;">&larr; Back to Feed</a>
    
    <div class="detail-header">
        <h1 class="detail-title">{{ opportunity.title }}</h1>
        <div class="detail-badges">
            <span class="badge {{ 'badge-rfi' if opportunity.opportunity_type in ['RFI', 'Sources Sought'] else 'badge-type' }}">{{ opportunity.opportunity_type }}</span>
            {% if opportunity.set_aside %}
                <span class="badge badge-setaside">{{ opportunity.set_aside }}</span>
            {% endif %}
            {% if decision_state == "SAVED" %}
              <span class="badge badge-saved">Shortlisted</span>
            {% elif decision_state == "BID" %}
              <span class="badge badge-inprogress">Go Bid</span>
            {% elif decision_state == "NO_BID" %}
              <span class="badge badge-dropped">No Bid</span>
            {% endif %}
        </div>
    </div>
    
    <div class="detail-meta">
        <div class="detail-meta-item">
            <div class="detail-meta-label">Agency</div>
            <div class="detail-meta-value">{{ opportunity.agency }}</div>
        </div>
        <div class="detail-meta-item">
            <div class="detail-meta-label">Response Deadline</div>
            <div class="detail-meta-value {{ 'due-urgent' if days_until_due <= 7 else 'due-soon' if days_until_due <= 14 else '' }}">
                {{ opportunity.response_deadline.strftime('%B %d, %Y') }}
                {% if days_until_due >= 0 %}
                    ({{ days_until_due }} days left)
                {% else %}
                    (past due)
                {% endif %}
            </div>
        </div>
        <div class="detail-meta-item">
            <div class="detail-meta-label">Posted Date</div>
            <div class="detail-meta-value">{{ opportunity.posted_date.strftime('%B %d, %Y') }}</div>
        </div>
        {% if opportunity.naics %}
        <div class="detail-meta-item">
            <div class="detail-meta-label">NAICS Code</div>
            <div class="detail-meta-value">{{ opportunity.naics }}</div>
        </div>
        {% endif %}
        <div class="detail-meta-item">
            <div class="detail-meta-label">SAM.gov ID</div>
            <div class="detail-meta-value">{{ opportunity.sam_notice_id }}</div>
        </div>
        {% if user_opp and user_opp.internal_deadline %}
        <div class="detail-meta-item">
            <div class="detail-meta-label">Your Internal Deadline</div>
            <div class="detail-meta-value">{{ user_opp.internal_deadline.strftime('%B %d, %Y') }}</div>
        </div>
        {% endif %}
    </div>
    
    {% if opportunity.description %}
    <div class="detail-description">
        <h2>Description</h2>
        <p>{{ opportunity.description }}</p>
    </div>
    {% endif %}
    
    <div class="detail-actions">
        <div class="detail-votes" style="display:flex; gap:10px; align-items:center; margin-bottom: 14px;">
          <button type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="voteOpp('{{ opportunity.id }}', 'UP')">
            üëç <span id="voteUpCount">{{ up_count }}</span>
            {% if my_vote == "UP" %}‚úì{% endif %}
          </button>

          <button type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="voteOpp('{{ opportunity.id }}', 'DOWN')">
            üëé <span id="voteDownCount">{{ down_count }}</span>
            {% if my_vote == "DOWN"%}‚úì{% endif %}
          </button>
          <button type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="voteOpp('{{ opportunity.id }}', 'PASS')">
             Pass ‚è≠Ô∏è {{ pass_count }} {% if my_vote == "PASS" %}‚úì{% endif %}
          </button>
          {% if my_vote != 0 %}
            <button type="button"
                    class="btn btn-light btn-sm"
                    onclick="voteOpp('{{ opportunity.id }}', '')">
              Undo
            </button>
          {% endif %}
        </div>

        {% if decision_state == "FEED" %}
          <button type="button" class="btn btn-primary"
                  onclick="transitionOpp('{{ opportunity.id }}','SAVED')">Shortlist</button>

          <button type="button" class="btn btn-danger"
                  onclick="transitionOpp('{{ opportunity.id }}','NO_BID')">No Bid</button>

        {% elif decision_state == "SAVED" %}
          <button type="button" class="btn btn-success"
                  onclick="transitionOpp('{{ opportunity.id }}','BID')">Go Bid</button>

          <button type="button" class="btn btn-danger"
                  onclick="transitionOpp('{{ opportunity.id }}','NO_BID')">No Bid</button>

        {% elif decision_state == "BID" %}
          <span class="badge badge-inprogress">Go Bid</span>

        {% elif decision_state == "NO_BID" %}
          <span class="badge badge-dropped">No Bid</span>
        {% endif %}

        {% if user_opp %}
        <div class="detail-form">
          <form method="POST" action="/opportunity/{{ opportunity.id }}/update">
              <div class="form-group">
                  <label for="internal_deadline">Internal Deadline</label>
                  <input type="date" id="internal_deadline" name="internal_deadline"
                         value="{{ user_opp.internal_deadline.strftime('%Y-%m-%d') if user_opp and user_opp.internal_deadline else '' }}">
              </div>
              <div class="form-group">
                  <label for="notes">Notes</label>
                  <textarea id="notes" name="notes" placeholder="Add your notes here...">{{ user_opp.notes if user_opp and user_opp.notes else '' }}</textarea>
              </div>
              <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
async function transitionOpp(oppId, toState) {
  const res = await fetch('/api/transition', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      opp_id: Number(oppId),
      to_state: toState,
      ui_version: "v1"
    })
  });
  const data = await res.json();
  if (!res.ok) { alert(data.detail || 'Error'); return; }
  window.location.reload();
}
</script>
<script>
async function voteOpp(oppId, vote) {
  const payload = {
    opp_id: Number(oppId),
    ui_version: "v1"
  };

  // Only include vote if UP/DOWN; omitting vote = clear
  if (vote === "UP" || vote === "DOWN" || vote === "PASS") {
    payload.vote = vote;
  }

  const res = await fetch('/api/vote', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    // Keep it simple for users
    const data = await res.json().catch(() => ({}));
    alert(data.detail || "Error saving vote");
    return;
  }

  window.location.reload();
}
</script>
{% endblock %}
